(function(m){var t=function(){var m=function(a){var b={data:[],heatmap:a};this.max=1;this.get=function(a){return b[a]};this.set=function(a,c){b[a]=c}};m.prototype={addDataPoint:function(a,b){if(!(0>a||0>b)){var d=this.get("heatmap"),c=this.get("data");c[a]||(c[a]=[]);c[a][b]||(c[a][b]=0);c[a][b]+=3>arguments.length?1:arguments[2];this.set("data",c);this.max<c[a][b]?(d.get("actx").clearRect(0,0,d.get("width"),d.get("height")),this.setDataSet({max:c[a][b],data:c},!0)):d.drawAlpha(a,b,c[a][b],!0)}},
setDataSet:function(a,b){var d=this.get("heatmap"),c=[],e=a.data,f=e.length;d.clear();this.max=a.max;d.get("legend")&&d.get("legend").update(a.max);if(null!=b&&b)for(var g in e){if(void 0!==g)for(var h in e[g])void 0!==h&&d.drawAlpha(g,h,e[g][h],!1)}else for(;f--;)g=e[f],d.drawAlpha(g.x,g.y,g.count,!1),c[g.x]||(c[g.x]=[]),c[g.x][g.y]||(c[g.x][g.y]=0),c[g.x][g.y]=g.count;d.colorize();this.set("data",e)},exportDataSet:function(){var a=this.get("data"),b=[],d;for(d in a)if(void 0!==d)for(var c in a[d])void 0!==
c&&b.push({x:parseInt(d,10),y:parseInt(c,10),count:a[d][c]});return{max:this.max,data:b}},generateRandomDataSet:function(a){var b=this.get("heatmap"),d=b.get("width"),b=b.get("height"),c={},e=Math.floor(1E3*Math.random()+1);c.max=e;for(var f=[];a--;)f.push({x:Math.floor(Math.random()*d+1),y:Math.floor(Math.random()*b+1),count:Math.floor(Math.random()*e+1)});c.data=f;this.setDataSet(c)}};var p=function(a){this.config=a;var b={element:null,labelsEl:null,gradientCfg:null,ctx:null};this.get=function(a){return b[a]};
this.set=function(a,c){b[a]=c};this.init()};p.prototype={init:function(){var a=this.config,b=a.title||"Legend",d=a.position,c=a.offset||10,a=document.createElement("ul"),e="";this.processGradientObject();e=-1<d.indexOf("t")?e+("top:"+c+"px;"):e+("bottom:"+c+"px;");e=-1<d.indexOf("l")?e+("left:"+c+"px;"):e+("right:"+c+"px;");d=document.createElement("div");d.style.cssText="border-radius:5px;position:absolute;"+e+"font-family:Helvetica; width:256px;z-index:10000000000; background:rgba(255,255,255,1);padding:10px;border:1px solid black;margin:0;";
d.innerHTML="<h3 style='padding:0;margin:0;text-align:center;font-size:16px;'>"+b+"</h3>";a.style.cssText="position:relative;font-size:12px;display:block;list-style:none;list-style-type:none;margin:0;height:15px;";b=document.createElement("div");b.style.cssText=["position:relative;display:block;width:256px;height:15px;border-bottom:1px solid black; background-image:url(",this.createGradientImage(),");"].join("");d.appendChild(a);d.appendChild(b);this.set("element",d);this.set("labelsEl",a);this.update(1)},
processGradientObject:function(){var a=this.config.gradient,b=[],d;for(d in a)a.hasOwnProperty(d)&&b.push({stop:d,value:a[d]});b.sort(function(a,b){return a.stop-b.stop});b.unshift({stop:0,value:"rgba(0,0,0,0)"});this.set("gradientArr",b)},createGradientImage:function(){var a=this.get("gradientArr"),b=a.length,d=document.createElement("canvas"),c=d.getContext("2d"),e;d.width="256";d.height="15";e=c.createLinearGradient(0,5,256,10);for(var f=0;f<b;f++)e.addColorStop(1/(b-1)*f,a[f].value);c.fillStyle=
e;c.fillRect(0,5,256,10);c.strokeStyle="black";c.beginPath();for(f=0;f<b;f++)c.moveTo((1/(b-1)*f*256>>0)+.5,0),c.lineTo((1/(b-1)*f*256>>0)+.5,0==f?15:5);c.moveTo(255.5,0);c.lineTo(255.5,15);c.moveTo(255.5,4.5);c.lineTo(0,4.5);c.stroke();this.set("ctx",c);return d.toDataURL()},getElement:function(){return this.get("element")},update:function(a){for(var b=this.get("gradientArr"),d=this.get("ctx"),c=this.get("labelsEl"),e,f="",g,h=0;h<b.length;h++)e=a*b[h].stop>>0,g=d.measureText(e).width/2>>0,0==h&&
(g=0),h==b.length-1&&(g*=2),f+='<li style="position:absolute;left:'+(((1/(b.length-1)*h*256||0)>>0)-g+.5)+'px">'+e+"</li>";c.innerHTML=f}};var s=function(a){var b={radius:40,element:{},canvas:{},acanvas:{},ctx:{},actx:{},legend:null,visible:!0,width:0,height:0,max:!1,gradient:!1,opacity:180,premultiplyAlpha:!1,bounds:{l:1E3,r:0,t:1E3,b:0},debug:!1};this.store=new m(this);this.get=function(a){return b[a]};this.set=function(a,c){b[a]=c};this.configure(a);this.init()};s.prototype={configure:function(a){this.set("radius",
a.radius||40);this.set("element",a.element instanceof Object?a.element:document.getElementById(a.element));this.set("visible",null!=a.visible?a.visible:!0);this.set("max",a.max||!1);this.set("gradient",a.gradient||{"0.45":"rgb(0,0,255)","0.55":"rgb(0,255,255)","0.65":"rgb(0,255,0)","0.95":"yellow",1:"rgb(255,0,0)"});this.set("opacity",parseInt(255/(100/a.opacity),10)||180);this.set("width",a.width||0);this.set("height",a.height||0);this.set("debug",a.debug);a.legend&&(a=a.legend,a.gradient=this.get("gradient"),
this.set("legend",new p(a)))},resize:function(){var a=this.get("element"),b=this.get("canvas"),d=this.get("acanvas");b.width=d.width=this.get("width")||a.style.width.replace(/px/,"")||this.getWidth(a);this.set("width",b.width);b.height=d.height=this.get("height")||a.style.height.replace(/px/,"")||this.getHeight(a);this.set("height",b.height)},init:function(){var a=document.createElement("canvas"),b=document.createElement("canvas"),d=a.getContext("2d"),c=b.getContext("2d"),e=this.get("element");this.initColorPalette();
this.set("canvas",a);this.set("ctx",d);this.set("acanvas",b);this.set("actx",c);this.resize();a.style.cssText=b.style.cssText="position:absolute;top:0;left:0;z-index:10000000;";this.get("visible")||(a.style.display="none");e.appendChild(a);this.get("legend")&&e.appendChild(this.get("legend").getElement());this.get("debug")&&document.body.appendChild(b);c.shadowOffsetX=15E3;c.shadowOffsetY=15E3;c.shadowBlur=15},initColorPalette:function(){var a=document.createElement("canvas"),b=this.get("gradient"),
d,c;a.width="1";a.height="256";a=a.getContext("2d");d=a.createLinearGradient(0,0,1,256);c=a.getImageData(0,0,1,1);c.data[0]=c.data[3]=64;c.data[1]=c.data[2]=0;a.putImageData(c,0,0);c=a.getImageData(0,0,1,1);this.set("premultiplyAlpha",60>c.data[0]||70<c.data[0]);for(var e in b)d.addColorStop(e,b[e]);a.fillStyle=d;a.fillRect(0,0,1,256);this.set("gradient",a.getImageData(0,0,1,256).data)},getWidth:function(a){var b=a.offsetWidth;a.style.paddingLeft&&(b+=a.style.paddingLeft);a.style.paddingRight&&(b+=
a.style.paddingRight);return b},getHeight:function(a){var b=a.offsetHeight;a.style.paddingTop&&(b+=a.style.paddingTop);a.style.paddingBottom&&(b+=a.style.paddingBottom);return b},colorize:function(a,b){var d=this.get("width"),c=this.get("radius"),e=this.get("height"),f=this.get("actx"),g=this.get("ctx"),h=3*c,c=this.get("premultiplyAlpha"),r=this.get("gradient"),m=this.get("opacity"),l=this.get("bounds"),q,k,n;null!=a&&null!=b?(a+h>d&&(a=d-h),0>a&&(a=0),0>b&&(b=0),b+h>e&&(b=e-h),q=a,d=b,k=a+h,e=b+
h):(q=0>l.l?0:l.l,k=l.r>d?d:l.r,d=0>l.t?0:l.t,e=l.b>e?e:l.b);f=f.getImageData(q,d,k-q,e-d);e=f.data;h=e.length;for(k=3;k<h;k+=4)if(n=e[k],l=4*n)n=n<m?n:m,e[k-3]=r[l],e[k-2]=r[l+1],e[k-1]=r[l+2],c&&(e[k-3]/=255/n,e[k-2]/=255/n,e[k-1]/=255/n),e[k]=n;f.data=e;g.putImageData(f,q,d)},drawAlpha:function(a,b,d,c){var e=this.get("radius"),f=this.get("actx");this.get("max");var g=this.get("bounds"),h=a-1.5*e>>0,m=b-1.5*e>>0,p=a+1.5*e>>0,l=b+1.5*e>>0;f.shadowColor="rgba(0,0,0,"+(d?d/this.store.max:"0.1")+")";
f.shadowOffsetX=15E3;f.shadowOffsetY=15E3;f.shadowBlur=15;f.beginPath();f.arc(a-15E3,b-15E3,e,0,2*Math.PI,!0);f.closePath();f.fill();c?this.colorize(h,m):(h<g.l&&(g.l=h),m<g.t&&(g.t=m),p>g.r&&(g.r=p),l>g.b&&(g.b=l))},toggleDisplay:function(){var a=this.get("visible");this.get("canvas").style.display=a?"none":"block";this.set("visible",!a)},getImageData:function(){return this.get("canvas").toDataURL()},clear:function(){var a=this.get("width"),b=this.get("height");this.store.set("data",[]);this.get("ctx").clearRect(0,
0,a,b);this.get("actx").clearRect(0,0,a,b)},cleanup:function(){this.get("element").removeChild(this.get("canvas"))}};return{create:function(a){return new s(a)},util:{mousePosition:function(a){var b,d;a.layerX?(b=a.layerX,d=a.layerY):a.offsetX&&(b=a.offsetX,d=a.offsetY);if("undefined"!=typeof b)return[b,d]}}}}();m.h337=m.heatmapFactory=t})(window);